{"AWSTemplateFormatVersion":"2010-09-09","Resources":{"RestApi":{"Type":"AWS::ApiGateway::RestApi","Properties":{"Name":"sefsuggestionsRestApi","Description":"The REST API for for your Super Easy Form","EndpointConfiguration":{"Types":["REGIONAL"]}}},"ApiModel":{"Type":"AWS::ApiGateway::Model","Properties":{"ContentType":"application/json","Name":"sefsuggestionsApiModel","RestApiId":{"Ref":"RestApi"},"Schema":{"$schema":"http://json-schema.org/draft-04/schema#","title":"sefsuggestions","type":"object","additionalProperties":false,"properties":{"id":{"type":"string"},"message":{"type":"string"}},"required":["id","message"]}}},"ApiValidator":{"Type":"AWS::ApiGateway::RequestValidator","Properties":{"RestApiId":{"Ref":"RestApi"},"Name":"sefsuggestionsValidation","ValidateRequestBody":true,"ValidateRequestParameters":true}},"ApiPostMethod":{"Type":"AWS::ApiGateway::Method","Properties":{"AuthorizationType":"NONE","HttpMethod":"POST","ResourceId":{"Fn::GetAtt":["RestApi","RootResourceId"]},"RestApiId":{"Ref":"RestApi"},"ApiKeyRequired":false,"Integration":{"Type":"AWS","IntegrationHttpMethod":"POST","Uri":{"Fn::Join":["",["arn:aws:apigateway:",{"Ref":"AWS::Region"},":lambda:path/2015-03-31/functions/",{"Fn::GetAtt":["LambdaFunction","Arn"]},"/invocations"]]},"IntegrationResponses":[{"ResponseTemplates":{"application/json":"$input.json('$.body')"},"ResponseParameters":{"method.response.header.Link":"integration.response.body.headers.next","method.response.header.Access-Control-Allow-Origin":"'*'"},"StatusCode":200}]},"RequestValidatorId":{"Ref":"ApiValidator"},"MethodResponses":[{"ResponseModels":{"application/json":{"Ref":"ApiModel"}},"ResponseParameters":{"method.response.header.Link":true,"method.response.header.Access-Control-Allow-Origin":false},"StatusCode":200}]},"DependsOn":["LambdaFunction"]},"ApiOptionsMethod":{"Type":"AWS::ApiGateway::Method","Properties":{"AuthorizationType":"NONE","HttpMethod":"OPTIONS","ResourceId":{"Fn::GetAtt":["RestApi","RootResourceId"]},"RestApiId":{"Ref":"RestApi"},"ApiKeyRequired":false,"Integration":{"IntegrationHttpMethod":"OPTIONS","Type":"MOCK","RequestTemplates":{"application/json":"{\n \"statusCode\": 200\n}"},"PassthroughBehavior":"WHEN_NO_MATCH","TimeoutInMillis":29000,"CacheNamespace":{"Fn::GetAtt":["RestApi","RootResourceId"]},"Uri":{"Fn::Join":["",["arn:aws:apigateway:",{"Ref":"AWS::Region"},":lambda:path/2015-03-31/functions/",{"Fn::GetAtt":["LambdaFunction","Arn"]},"/invocations"]]},"IntegrationResponses":[{"ResponseTemplates":{"application/json":""},"ResponseParameters":{"method.response.header.Access-Control-Allow-Headers":"'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'","method.response.header.Access-Control-Allow-Methods":"'POST,OPTIONS'","method.response.header.Access-Control-Allow-Origin":"'*'"},"StatusCode":200}]},"MethodResponses":[{"ResponseModels":{"application/json":"Empty"},"ResponseParameters":{"method.response.header.Access-Control-Allow-Headers":false,"method.response.header.Access-Control-Allow-Methods":false,"method.response.header.Access-Control-Allow-Origin":false},"StatusCode":200}]},"DependsOn":["LambdaFunction"]},"DynamoDbTable":{"Type":"AWS::DynamoDB::Table","Properties":{"AttributeDefinitions":[{"AttributeName":"id","AttributeType":"S"}],"KeySchema":[{"AttributeName":"id","KeyType":"HASH"}],"TableName":"sefsuggestions","BillingMode":"PAY_PER_REQUEST"}},"LambdaFunction":{"Type":"AWS::Lambda::Function","Properties":{"Code":{"S3Bucket":"sefsuggestionsfunction","S3Key":"sefsuggestionsFunction.zip"},"Description":"This Lambda Function Adds your contact info. to a Dynamo DB table and then sends you an email.","Environment":{"Variables":{"RECAPTCHA_SECRET":"6LfdUNIUAAAAAKRpH0YdlvY8TpCbA5_2UVPP35Lu"}},"FunctionName":"sefsuggestionsFunction","Handler":"index.handler","MemorySize":128,"Role":{"Fn::GetAtt":["IamRole","Arn"]},"Runtime":"nodejs10.x","Tags":[{"Key":"formName","Value":"sefsuggestions"}],"Timeout":30},"DependsOn":["DynamoDbTable","IamRole"]},"LambdaPermission":{"Type":"AWS::Lambda::Permission","Properties":{"Action":"lambda:InvokeFunction","FunctionName":{"Ref":"LambdaFunction"},"Principal":"apigateway.amazonaws.com","SourceArn":{"Fn::Join":["",["arn:aws:execute-api:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":",{"Ref":"RestApi"},"/*/POST/"]]}},"DependsOn":["ApiPostMethod"]},"IamPolicy":{"Type":"AWS::IAM::Policy","Properties":{"PolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["dynamodb:GetItem","dynamodb:PutItem","dynamodb:UpdateItem"],"Resource":{"Fn::GetAtt":["DynamoDbTable","Arn"]}},{"Effect":"Allow","Resource":{"Fn::Join":["",["arn:aws:ses:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":identity/mailer@torus-digital.com"]]},"Action":["SES:SendEmail","SES:SendRawEmail"]}]},"PolicyName":"sefsuggestionsPolicy","Roles":[{"Ref":"IamRole"}]}},"IamRole":{"Type":"AWS::IAM::Role","Properties":{"AssumeRolePolicyDocument":{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Principal":{"Service":"lambda.amazonaws.com"},"Action":"sts:AssumeRole"}]},"Description":"Role that allows the Lambda function to interact with the IAM policy","RoleName":"sefsuggestionsFormRole"}},"ApiDeployment":{"Type":"AWS::ApiGateway::Deployment","Properties":{"Description":"deployment of the REST API for the sefsuggestions form","RestApiId":{"Ref":"RestApi"},"StageName":"DeploymentStage"},"DependsOn":["ApiPostMethod"]}}}